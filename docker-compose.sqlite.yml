version: '3.8'

services:
  # ====================================
  # Aplicação Flask
  # ====================================
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: prova_modelagem_app
    restart: unless-stopped

    # Portas
    ports:
      - "5000:5000"

    # Variáveis de ambiente
    environment:
      - FLASK_ENV=production
      - FLASK_DEBUG=False
      - SECRET_KEY=${SECRET_KEY:-change-me-in-production-super-secret-key-12345}
      - DATABASE_URL=sqlite:////app/data/provas.db
      - MAX_CONTENT_LENGTH=16777216
      - PORT=5000
      - HOST=0.0.0.0

    # Volumes persistentes
    volumes:
      # Banco de dados SQLite
      - app_data:/app/data
      # Arquivos enviados (fotos, PPTs, tabelas)
      - app_uploads:/app/uploads
      # Logs
      - app_logs:/app/logs

    # Health check
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:5000/').read()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # Recursos
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M

    # Rede
    networks:
      - app_network

  # ====================================
  # Nginx Reverse Proxy (Opcional)
  # ====================================
  nginx:
    image: nginx:alpine
    container_name: prova_modelagem_nginx
    restart: unless-stopped

    # Portas
    ports:
      - "80:80"
      - "443:443"

    # Volumes
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
      - app_uploads:/usr/share/nginx/html/uploads:ro

    # Depende da app
    depends_on:
      - app

    # Rede
    networks:
      - app_network

    # Descomente para usar
    profiles:
      - with-nginx

# ====================================
# Volumes Persistentes
# ====================================
volumes:
  # Banco de dados SQLite
  app_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./data

  # Uploads (fotos, documentos)
  app_uploads:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./uploads

  # Logs da aplicação
  app_logs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./logs

# ====================================
# Rede
# ====================================
networks:
  app_network:
    driver: bridge
